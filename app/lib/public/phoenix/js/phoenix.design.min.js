"use strict";!function(a,b){var c=a.layout,d=a.dom,e=function(a,b,d){for(var e,f,g=a.target,h=null;g;){var h=g.getAttribute("data-layout");if(h){if(e=parseInt(g.getAttribute("data-level")||"1",10),f=d.getLayoutById(h),f&&c.utils.canSelect(f,e)||(h=null),h)break}else if(h=g.getAttribute("data-render"))break;g=g==b?null:g.parentNode}return h},f=function(a,b){for(var c=a.target;c;){if(c.hasAttribute("data-remove"))return!0;c=c==b?null:c.parentNode}return!1},g=function(a){return a.originalEvent?a.originalEvent:a},h=function(a,d){if(!a)return null;var e,f,g,h;a.map&&(e=!0,f=a.map,a.map=null,g=a.fields,a.fields=null),d&&(h=a.$items,h&&(a.$items=[]),"row"==a.$type&&(a.$columns=h.length));var i=b.extend(!0,{},a);return e&&(a.map=f,a.fields=g,delete i.fields,delete i.map),d&&(a.$items=h,delete a.$columns),i.$type?(c.utils.clearMeta(i,!d),d&&delete i.$items):(delete i.$parentId,delete i.$idDrag),i},i=function(a,c,d){for(var e=[],f=a.childNodes,g=0,h=f.length;h>g;g++){var i=f[g],j=b(i).offset();e.push({top:j.top+(j.height>>1),ignore:i==c||i.hasAttribute("data-remove"),placeHolder:i==d})}return e},j=function(a,b){var c=0;if(a.length){for(var d=0,e=a.length;e>d;d++){var f=a[d];if(!f.ignore&&b<f.top)return d;c=d+1}return c}return c},k=function(a,b,c,d){for(var e=0,f=0,g=a.childNodes.length;g>f;f++){var h=a.childNodes[f];if(h==b)return e;h!=c&&(!d||h.hasAttribute("data-layout"))&&(d||h.hasAttribute("data-render"))&&e++}return 0},l=function(a,b,c,e,f,g){var h=function(a){e.parentNode&&d.remove(e),f.$type&&!a&&("column"==f.$type&&1==g?d.addClass(e,"col"):d.removeClass(e,"col"))};if(!b.length)return h(!1),d.append(a,e),!0;for(var i=-1,j=0,k=b.length;k>j;j++){var l=b[j];if(l.placeHolder){if(i=j,j==c||j==c-1)return!1}else if(l.ignore){if(j==c&&k>j+1&&b[j+1].placeHolder)return!1;if(j==c-1&&j>0&&b[j-1].placeHolder)return!1}}if(0>i||c>=b.length)h(i>=0),d.append(a,e);else{var m=a.childNodes[c];h(i>=0),d.before(m,e)}return!0},m=function(a,b,c,e,f){return c?(b&&d.remove(b),b=document.createElement("div"),b.className=a.className,d.addClass(b,"drop-target"),d.before(a,b),b):(b=n(b,!1,e,f),d.before(a,b),b)},n=function(a,b,c,e){return a&&d.remove(a),a=document.createElement("div"),a.className="container-fluid no-x-padding drop-layouts-zone drop-fields-zone design drop-target"+(c?" bs-island bs-field":"")+(e?" bs-island bs-widget":""),a},o=function(){var a=document.createElement("div");return a.className="bs-drag-image",document.body.appendChild(a),a},p=function(a,b){if(a){var c=d.find(a.get(0),b.$idDrag);b.selected?d.addClass(c,"selected"):d.removeClass(c,"selected")}},q=function(c,e,f){if(e){var g=d.find(c,e.$idDrag);if(c!=g)if(e.selected){var i=g.querySelector('div[data-remove="true"]');if(!i){var j=b('<div class="bs-rt-button" data-remove="true"><span class="glyphicon glyphicon-remove-sign"></span></div>').get(0),k=g.childNodes;k.length?d.before(k[0],j):d.append(g,j)}}else{var l=g.querySelector('div[data-remove="true"]');l&&d.remove(l)}}if(f){var m=h(e,!0);m&&delete m.$id,a.ipc.emit("SelectedChanged",{type:e?e.$type?"layout":e.$config?"widget":"field":null,id:e?e.$id:null,data:m})}},r=function(a,b,c){c&&(a.off("click"),a.find('div[draggable="true"]').off("dragstart").add(a).off("dragend"),a.find('div[draggable="true"]').off("dragstart"),a.find(".drop-layouts-zone, .drop-fields-zone").add(a).off("dragover dragenter drop"))},s=function(b,h,p){if(p){var q,t,u,v,w,x=function(){q&&(d.removeClass(q,"bs-none"),q=null),v&&(d.remove(v),v=null),t&&(d.remove(t),t=null),w=null,u=!1,a.drag.setData(null)},y=function(a){var c=b.get(0);if(a){if(a.data==a.dst)return;var e,f,g,i,j=a.dst,k=a.data,l=d.find(c,k.$id),m=d.find(c,j.$idDesign);if(k.$parentId==j.$id){if(g=a.dst,f=g.$items.indexOf(k),e=a.indexInParent,e==f)return}else g=a.isNew?null:h.getLayoutById(k.$parentId),f=g?g.$items.indexOf(k):-1,e=a.indexInParent;if(k.$parentId=j.$id,f>=0&&g.$items.splice(f,1),j.$items.splice(e,0,k),!a.isNew){f>=0&&(l=d.detach(l)),e==j.$items.length-1?d.append(m,l):(i=d.find(c,j.$items[e+1].$id),d.before(i,l));var n=[g];return a.isLayout&&n.push(k),j!=g&&n.push(j),r(b,h,p),s(b,h,p),void n.forEach(function(a){h._afterPropsChanged(a)})}h.check(k,j),h.render()}};b.on("click",function(a){var c=e(a,b.get(0),h);return f(a,b.get(0))?void h.removeChild(c):void h.select(c)}),b.find('div[draggable="true"]').on("dragstart",function(c){c.stopPropagation();var e=!1,f=!0,i=!1,j=h.getLayoutById(this.getAttribute("data-layout"));if(j||(j=h.getFieldById(this.getAttribute("data-render")),i=null!=j.$config,e=!i,f=!1),!j)return c.preventDefault(),!1;var k=g(c).dataTransfer;k.effectAllowed="move",k.setData("Text","data"),f&&k.setDragImage&&(t=o(!0),k.setDragImage(t,0,0)),a.drag.setData({data:j,isLayout:f,isField:e,isWidget:i,isNew:!1}),q=d.find(b.get(0),j.$idDrag),u=!0}).add(b).on("dragend",function(a){return a.preventDefault(),a.stopPropagation(),x(),!1}),b.find(".drop-layouts-zone, .drop-fields-zone").add(b).on("dragover dragenter drop",function(b){var e=this,f=a.drag.getData(),o=g(b),p=o.dataTransfer;if(b.stopPropagation(),!f||!f.isLayout&&!d.hasClass(e,"drop-fields-zone")||f.isLayout&&!d.hasClass(e,"drop-layouts-zone"))return p.effectAllowed="none",!0;if("drop"==b.type){b.preventDefault();var r=h.getLayoutById(e.getAttribute("data-layout")),s=e.getAttribute("data-level");return r?(f=a.drag.getData(),f.dst=r,f.dstLevel=s,f.indexInParent=k(e,v,q,f.isLayout),a.drag.setData(f),x(),y(f),!1):(x(),!1)}if(p.getData("Text"),u){if(!q)return;if(u=!1,!f.isNew)return v=m(q,v,f.isLayout,f.isField,f.isWidget),d.addClass(q,"bs-none"),b.preventDefault(),!1}var t=h.getLayoutById(e.getAttribute("data-layout")),z=e.getAttribute("data-level");if(!v){if(!f.isNew)return!0;if(!c.utils.canDropChild(f.data,t,z))return p.effectAllowed="none",!0;w=i(e,q,v);var A=j(w,o.pageY);return v=n(v,f.isLayout,f.isField,f.isWidget),l(e,w,A,v,t,z),w=null,b.preventDefault(),!1}if("dragenter"==b.type&&(w=null),q==e)return p.effectAllowed="none",!0;if(!c.utils.canDropChild(f.data,t,z))return p.effectAllowed="none",!0;w||(w=i(e,q,v));var B=j(w,o.pageY);return l(e,w,B,v,t,z)&&(w=null),b.preventDefault(),!1})}},t=a.ui.Layout,u={_setDesignListeners:function(b){a.ipc.listen("onToolBoxDragend",function(){this.$element&&this.$element.trigger("dragend")},this),a.ipc.listen("onUpdateSelected",function(a){"layout"==a.type&&this.updateLayout(a.id,a.data)},this),a.ipc.listen("onAuthoringModeChanged",function(a){b.setDesignMode(a)},this)},_removeEvents:function(){r(this.$element,this,!0)},_addEvents:function(){s(this.$element,this,this.options.design)},_onSelectedChanged:function(a,b,c){q(a,b,c)},toString:function(a){var b=h(a||this.data,!1);return JSON.stringify(b,2)},_showSelected:function(a,b){p(a,b)},toString:function(a){var b=h(a||this.data,!1);return JSON.stringify(b,2)}};b.extend(t.prototype,u),a.ui=a.ui||{},a.ui.Layout=t}(Phoenix,$),function(a){var b=function(a,b,c,d){a.$id=d.allocID(),b&&(a.$parentId=b.$id),a.$items&&(a.$contentId=d.allocUuid()),c&&(c[a.$id]=a)},c=function(a,b){a.push('<div class="panel-group" id="'+b.$id+'">')},d=function(a){a.push("</div>")},e=function(a,b,c){a.push('<div class="panel panel-default" id="'+b.$id+'">'),a.push('<div class="panel-heading">'),a.push('<h3 class="panel-title">'),a.push('<a data-toggle="collapse" draggable="false" data-parent="#'+c.$id+'" href="#'+c.$contentId+'"><span class="glyphicon glyphicon-folder-close bs-icon-space">'),a.push("</span>"),a.push(b.$title),a.push("</a></h3></div>"),a.push('<div id="'+c.$contentId+'" class="panel-collapse collapse in">'),a.push(' <ul class="list-group">')},f=function(a){a.push("</ul></div></div>")},g=function(a,b){a.push('<li draggable="true" class="list-group-item bs-cursor-p" data-toolbox="'+b.$id+'" id="'+b.$id+'">'),a.push('<span class="glyphicon glyphicon-flash text-success bs-icon-space"></span>'),a.push(b.$title),a.push("</li>")},h=function(){},i=function(a,b,c){a&&(c(a,b,!0),a.$items&&a.$items.forEach(function(b){i(b,a,c)}),c(a,b,!1))},j=function(a,b,j){i(a,b,function(a,b,i){var k=g,l=h;switch(a.$type){case"groups":k=c,l=d;break;case"group":k=e,l=f;break;default:k=g,l=h}i?k(j,a,b):l(j,a,b)})};a.toolBox=a.toolBox||{};var k=a.toolBox;return k.utils=k.utils||{},k.utils.check=function(c,d){i(c,null,function(c,e,f){f&&b(c,e,d,a.utils)})},k.toHtml=function(b,c){var d=[];return j(b,c,d,a.locale,a.utils),d.join("")},a}(Phoenix),function(a,b){var c=a.toolBox,d=function(c,d){c.find('li[draggable="true"]').on("dragstart",function(c){c.stopPropagation();var e=d.getItemById(b(this).attr("data-toolbox"));if(!e||!e.data)return c.preventDefault(),!1;var f=c.originalEvent?c.originalEvent.dataTransfer:c.dataTransfer;f.effectAllowed="move",f.setData("Text","Data");var g={isNew:!0,data:b.extend(!0,{},e.data.data)};switch(e.data.$type){case"layout":g.isLayout=!0;break;case"field":g.isField=!0;break;case"widget":g.isWidget=!0}a.drag.setData(g)}).on("dragend",function(b){return a.ipc.emit("ToolBoxDragend"),a.drag.setData(null),b.preventDefault(),b.stopPropagation(),!1})},e=function(a){a.find('li[draggable="true"]').off("dragstart dragend")},f=function(a){this.$element=null,this.map={},c.utils.check(a,this.map),this.data=a},g={renderToolBox:function(a,d){return b(c.toHtml(a,d))},render:function(a){var b=this;b.$element||(b.$element=b.renderToolBox(b.data),a&&a.append(b.$element),d(b.$element,b))},_destroy:function(){var a=this;a.$element&&(e(a.$element,a),a.$element=null)},getItemById:function(a){if(!a)return null;var b=this;return b.map[a]}};b.extend(f.prototype,g),a.ui=a.ui||{},a.ui.ToolBox=f}(Phoenix,$);